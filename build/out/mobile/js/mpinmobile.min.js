var mpin=mpin||{};!function(){function a(a){if(!a||a.length%2!=0)return"";a=a.toLowerCase();for(var b="0123456789abcdef",c="",d=0;d<a.length;){var e=b.indexOf(a.charAt(d++)),f=b.indexOf(a.charAt(d++));if(0>e||0>f)return"";c+=String.fromCharCode(16*e+f)}return c}function b(a,b){var c;if(c="string"==typeof a?document.getElementById(a):a,c.className){var d=c.className.split(/\s+/g);d.indexOf(b)<0&&(c.className+=" "+b)}else c.className=b}function c(a,b){var c;if(c="string"==typeof a?document.getElementById(a):a,c&&c.className){var d=c.className.split(/\s+/g);d.splice(d.indexOf(b),1),c.className=d.join(" ")}}var d,e={},f={},g="../build/out/mobile/resources/templates/grey/img/";mpin=function(a,b){var c=this;d("../build/out/mobile/js/underscore-min.js",function(){d("../build/out/mobile/js/mpin-all.min.js",function(){d("../build/out/mobile/js/templates.min.js",function(){var d={};return b.clientSettingsURL?(mpin._=_.noConflict(),d.client=b,void c.ajax(b.clientSettingsURL,function(b){d.server=b,c.initialize.call(c,a,d)})):console.error("set client Settings")})})})},mpin.prototype.cfg={language:"en",pinpadDefaultMessage:"",pinSize:4,requiredOptions:"appID; signatureURL; mpinAuthServerURL; timePermitsURL; seedValue"},mpin.prototype.initialize=function(a,b){return this.el=document.getElementById(a),b&&this.checkOptions(b.server)?(h(),this.ds=this.dataSource(),this.setOptions(b.server).setOptions(b.client),this.language=this.opts.language&&e[this.opts.language]?this.opts.language:this.cfg.language,this.setLanguageText(),console.log("language:: ",this.language),console.log("language:: ",e),document.ontouchmove=function(a){a.preventDefault()},void this.renderHomeMobile()):console.error("Some options are required: "+this.cfg.requiredOptions)},mpin.prototype.checkOptions=function(a){var b;b=this.cfg.requiredOptions.split("; ");for(var c=0,d=b.length;d>c;c++)if("undefined"==typeof a[b[c]])return!1;return!0},mpin.prototype.setOptions=function(a){var b,c,d,e="stage; allowAddUser; requestOTP; successSetupURL; onSuccessSetup; successLoginURL; onSuccessLogin; onLoaded; onGetPermit; ";e+="onReactivate; onAccountDisabled; onUnsupportedBrowser; prerollid; onError; onGetSecret; mpinDTAServerURL; signatureURL; verifyTokenURL; certivoxURL; ",e+="mpinAuthServerURL; registerURL; accessNumberURL; mobileAppFullURL; authenticateHeaders; authTokenFormatter; accessNumberRequestFormatter; ",e+="registerRequestFormatter; onVerifySuccess; mobileSupport; emailCheckRegex; seedValue; appID; useWebSocket; setupDoneURL; timePermitsURL; authenticateURL; ",e+="language; customLanguageTexts; accessNumberDigits; mobileAuthenticateURL",c=e.split("; "),this.opts||(this.opts={}),this.opts.useWebSocket="WebSocket"in window&&2===window.WebSocket.CLOSING,this.opts.requestOTP="0";for(var b=0,f=c.length;f>b;b++)d=c[b],"undefined"!=typeof a[d]&&(this.opts[d]=a[d]);return this},mpin.prototype.readyHtml=function(a,b){var c,d=b;return mpin._.extend(d,{hlp:f,cfg:this.cfg}),c=mpin._.template(mpin.template[a],d)},mpin.prototype.render=function(a,b,c){var d,e=c||{};this.el.innerHTML=this.readyHtml(a,e);for(d in b)document.getElementById(d)&&(document.getElementById(d).addEventListener("touchstart",b[d],!1),document.getElementById(d).addEventListener("click",b[d],!1));"undefined"!=typeof mpin.custom&&this.setCustomStyle()},mpin.prototype.setLanguageText=function(){if(f.language=this.language,this.opts.customLanguageTexts&&this.opts.customLanguageTexts[this.language])for(var a in this.opts.customLanguageTexts[this.language])console.log("this.opts.customLanguageTexts[this.language]",this.opts.customLanguageTexts[this.language][a]),e[this.language][a]&&(e[this.language][a]=this.opts.customLanguageTexts[this.language][a])},mpin.prototype.renderHome=function(){var a={},b=this;this.opts.prerollid&&this.renderSetup(this.opts.prerollid),a.mpin_authenticate=function(a){b.ds.getDefaultIdentity()?b.renderLogin():b.renderSetupHome.call(b,a)},a.mp_action_Login1=function(){b.renderLogin.call(b)},a.mp_action_addIdentity2=a.mpin_authenticate,a.mp_action_Login2=a.mp_action_Login1,this.render("home",a),this.opts.mobileAppFullURL&&this.renderHomeMobile()},mpin.prototype.renderHomeMobile=function(){function a(){return navigator.userAgent.match(/(iPad|iPhone|iPod touch)/)&&navigator.userAgent.match(/AppleWebKit/)}function b(){return navigator.userAgent.match(/(iPad|iPhone);.*CPU.*OS 7_\d/i)}var c,d={},e=this;this.opts.prerollid&&this.renderSetup(this.opts.prerollid),d.mpin_authenticate=function(){e.renderSetupHome.call(e)},c=this.ds.getDefaultIdentity(),a()&&!window.navigator.standalone?b()?this.render("ios7-startup",d):this.render("ios6-startup",d):c?this.renderLogin():this.render("home_mobile",d)},mpin.prototype.renderSetupHome=function(){var a={},b=this;a.mp_action_home=function(a){b.renderHome.call(b,a)},a.mp_action_setup=function(a){b.actionSetupHome.call(b,a)},this.render("setup-home",a)},mpin.prototype.renderSetup=function(a,b,c){var d={},e=this;d.mp_action_home=function(a){e.renderHome.call(e,a)},d.mpinClear=function(){e.addToPin.call(e,"clear")},d.mpinLogin=function(){e.actionSetup.call(e)},d.menuBtn=function(){e.toggleButton.call(e)},this.render("setup",d,{email:a}),document.body.className="pinpadGlobal",this.enableNumberButtons(!0),this.bindNumberButtons(),this.requestSignature(a,b,c)},mpin.prototype.renderLogin=function(a){var b={},d=this;this.isAccNumber=!0;var e=this.ds.getDefaultIdentity(),g=this.getDisplayName(e);e||this.renderSetupHome(),b.mp_action_home=function(a){d.renderHome.call(d,a)},b.mpinClear=function(){d.addToPin.call(d,"clear")},b.menuBtn=function(){d.toggleButton.call(d)},b.mpinLogin=function(){var a=document.getElementById("pinpad-input");console.log("isAccNumber",d.isAccNumber),d.isAccNumber?(d.accessNumber=a.value,d.isAccNumber=!1,c(a,"blue-bg"),d.addToPin("login")):d.actionLogin.call(d)},this.render("setup",b,{email:g,menu:!0}),this.enableNumberButtons(!0),this.bindNumberButtons();var h=document.getElementById("pinpad-input");h.placeholder=f.text("pinpad_placeholder_text2"),h.type="text",a?this.toggleButton():this.setIdentity(this.ds.getDefaultIdentity(),!0,function(){d.display(d.cfg.pinpadDefaultMessage)},function(){return!1})},mpin.prototype.renderMobileLogin=function(){var a,b={},c=this;b.mp_action_home=function(b){console.log("reqInterval :: ",c.intervalID),console.log("_request :: ",a),a.abort(),clearInterval(c.intervalID),c.renderHome.call(c,b)},this.render("mobile-login",b),this.getAccessNumber(),a=this.getAccess()},mpin.prototype.getAccessNumber=function(){var a,b=new XMLHttpRequest,c=this;this.intervalID||(this.intervalID={}),a=function(a){var b=Math.floor((a-new Date)/1e3);0>=b?(c.intervalID&&clearInterval(c.intervalID),c.getAccessNumber()):document.getElementById("mp_seconds").innerHTML=b+" "+f.text("mobileAuth_seconds")},b.onreadystatechange=function(){var d,e;4===b.readyState&&200===b.status&&(d=JSON.parse(b.responseText),document.getElementById("mp_accessNumber").innerHTML=d.accessNumber,d.webOTP&&(c.webOTP=d.webOTP),e=new Date,e.setSeconds(e.getSeconds()+d.ttlSeconds),a(e),c.intervalID=setInterval(function(){a(e)},1e3))},b.open("GET",this.opts.accessNumberURL),b.send()},mpin.prototype.getAccess=function(){var a=new XMLHttpRequest,b=this;a.onreadystatechange=function(){var c;4===a.readyState&&(200===a.status?(c=JSON.parse(a.responseText),b.opts.onVerifySuccess?b.opts.onVerifySuccess(c):b.successLogin(c)):console.log("NOT success !!!"))},a.open("POST",this.opts.accessNumberURL,!0),a.timeout=3e4,a.ontimeout=function(){b.getAccess()};var c={};return this.webOTP?(sendParams.webOTP=this.webOTP,a.send(JSON.stringify(c))):a.send(),a},mpin.prototype.renderMobileSetup=function(){var a,b={},c=this;b.mp_action_home=function(){c.renderHome.call(c)},b.mp_action_cancel=function(){c.renderHome.call(c)},this.render("mobile-setup",b,{mobileAppFullURL:this.opts.mobileAppFullURL}),a=document.getElementById("mp_qrcode"),new QRCode(a,{text:this.opts.mobileAppFullURL,width:129,height:129})},mpin.prototype.renderActivateIdentity=function(){var a,b={},c=this;a=this.getDisplayName(this.identity),b.mp_action_home=function(a){c.renderHome.call(c,a)},b.mpin_action_setup=function(){c.beforeRenderSetup.call(c)},b.mpin_action_resend=function(a){c.actionResend.call(c,a)},this.render("activate-identity",b,{email:a})},mpin.prototype.beforeRenderSetup=function(){var a,b,c={},d=this;a=this.ds.getIdentityData(this.identity,"regOTP"),b=this.opts.signatureURL+"/"+this.identity+"?regOTP="+a,c.URL=b,c.method="GET",requestRPS(c,function(a){if(a.errorStatus)return void d.error("Activate identity");var b=d.getDisplayName(d.identity);d.renderSetup(b,a.clientSecretShare,a.params)})},mpin.prototype.renderAccountsPanel=function(){var a,b,c=this,d=0,e=document.getElementById("mp_back");b=function(a){var b=document.createElement("div");b.className="mp_contentEmptyItem",a.appendChild(b)},addMpinBack=function(){a=document.getElementById("mpinMaster").appendChild(document.createElement("div")),a.id="mp_back",e=document.getElementById("mp_back"),e.innerHTML=c.readyHtml("accounts-panel",{})},console.log("Trying to call here"),document.contains(e)===!1&&(addMpinBack(),e.style.display="block",console.log("Trying to call here again"),document.getElementById("mp_acclist_adduser").onclick=function(a){c.renderSetupHome.call(c,a)});var f=document.getElementById("mp_accountContent");this.addUserToList(f,this.ds.getDefaultIdentity(),!0,0);for(var g in this.ds.getAccounts())d+=1,g!=this.ds.getDefaultIdentity()&&this.addUserToList(f,g,!1,d);b(f)},mpin.prototype.renderUserSettingsPanel=function(a){var b,c,d=this;c=this.getDisplayName(a),b=document.getElementById("mp_back"),console.log("%c Hey!",b,"background: #222; color: red"),console.log(">>>>",c),console.log(">>>>",this.readyHtml("user-settings",{name:c})),b.innerHTML=this.readyHtml("user-settings",{name:c}),document.getElementById("mp_deluser").onclick=function(){d.renderDeletePanel.call(d,a)},document.getElementById("mp_reactivate").onclick=function(){d.renderReactivatePanel.call(d,a)},document.getElementById("mp_acclist_cancel").onclick=function(a){d.renderSetup.call(d,a),d.renderAccountsPanel.call(d,a)}},mpin.prototype.renderReactivatePanel=function(a){var b,c,d=this;c=this.getDisplayName(a),b=document.getElementById("mp_back"),b.innerHTML=this.readyHtml("reactivate-panel",{name:c}),document.getElementById("mp_acclist_reactivateuser").onclick=function(){d.renderSetup(d.getDisplayName(a))},document.getElementById("mp_acclist_cancel").onclick=function(){d.renderAccountsPanel()}},mpin.prototype.renderDeletePanel=function(a){var b,c,d=this;c=this.getDisplayName(a),b=document.getElementById("mp_back"),b.innerHTML=this.readyHtml("delete-panel",{name:c}),document.getElementById("mp_acclist_deluser").onclick=function(){d.deleteIdentity(a)},document.getElementById("mp_acclist_cancel").onclick=function(a){d.renderAccountsPanel.call(d,a)}},mpin.prototype.renderSetupDone=function(){var a,b={},c=this;a=this.getDisplayName(this.identity),b.mp_action_home=function(){c.renderHome.call(c)},b.mp_action_go=function(){c.renderLogin.call(c)},this.render("setup-done",b,{userId:a})},mpin.prototype.renderLogout=function(a){var b,c={},d=this;c.mpin_action_logout=function(){console.log("smth..............",a),d.ajaxPost("http://192.168.10.197:8005/logout",a,function(a){a&&d.renderLogin()})},this.render("logout",c,{userId:b})},mpin.prototype.addUserToList=function(a,b,d,e){function g(a){if("touchstart"==a.type||"click"==a.type){var d=document.getElementById("mp_back");d.parentNode.removeChild(d),c(document.getElementsByClassName("mp_itemSelected")[0],"mp_itemSelected"),k.ds.setDefaultIdentity(b),k.setIdentity(b,!0)}}var h,i,j,k=this;d?(h="mp_starButtonSelectedState",i="mp_contentItem one-edge-shadow default"):(h="mp_starButtonDefaultState",i="mp_contentItem one-edge-shadow"),j=document.createElement("div");var l=this.getDisplayName(b);j.setAttribute("tabindex","-1"),j.className=h,j.id="mp_accountItem_"+e;var m=document.createElement("div");m.className=i,m.setAttribute("data-identity",b),m.appendChild(j);var n={iNumber:e,name:l};mpin._.extend(n,{hlp:f,cfg:this.cfg}),m.innerHTML=mpin._.template(mpin.template["user-row"],n),a.appendChild(m),m.addEventListener("touchstart",g,!1),m.addEventListener("click",g,!1),document.getElementById("mp_btIdSettings_"+e).onclick=function(a){return console.log(b),k.renderUserSettingsPanel(b),a.stopPropagation(),!1}},mpin.prototype.renderIdentityNotActive=function(a){var b={},c=this;b.mp_action_home=function(a){c.renderHome.call(c,a)},b.mp_action_login=function(){var a=document.getElementById("mp_info_recheck"),b=this;this.style.display="none",a.className="info-checking",a.style.display="inline",a.innerHTML=f.text("setupNotReady_check_info1")+"<br/>",c.requestPermit(c.identity,function(){a.style.display="none",c.renderLogin(!0)},function(){document.getElementById("mp_info_recheck");a.className="info-error",a.innerHTML=f.text("setupNotReady_check_info2")+"<br/>",setTimeout(function(){a.style.display="none",b.style.display="inline-block"},1500)})},b.mp_action_resend=function(){var a=document.getElementById("mp_info_resend"),b=this;this.style.display="none",a.className="info-checking",a.innerHTML=f.text("setupNotReady_resend_info1"),requestRegister(c.opts.registerURL,c.identity,c.opts.authenticateHeaders,c.opts.registerRequestFormatter,function(){a.className="info-error",a.innerHTML=f.text("setupNotReady_resend_info2"),a.style.display="inline-block",setTimeout(function(){a.style.display="none",b.style.display="inline-block"},1500)},function(a,b){c.error(a,b),c.display(f.text("setupPin_errorSetupPin").mpin_format(b),!0)})},b.mp_action_accounts=function(){console.log(" CREATE frame ELEMENT before use this render HINT !!!"),c.renderLogin.call(c,!0,a)},this.render("identity-not-active",b,{email:a})},mpin.prototype.bindNumberButtons=function(){function a(a){c.addToPin(a.target.getAttribute("data-value"))}var b,c=this;b=document.getElementsByClassName("btn");for(var d=0;d<b.length;d++)b[d].addEventListener("touchstart",a,!1),b[d].addEventListener("click",a,!1)},mpin.prototype.enableNumberButtons=function(a){for(var b=document.getElementsByClassName("btn"),c=0;c<b.length;c++){var d=b[c];a?(d.className="btn",d.disabled=!1):(d.className="btn mp_inactive",d.disabled=!0)}},mpin.prototype.addToPin=function(a){var b=document.getElementById("pinpad-input");return"clear"===a?(this.display(""),this.enableNumberButtons(!0),this.enableButton(!1,"go"),void this.enableButton(!1,"clear")):"login"!==a||this.isAccNumber?(b.value+=a,void(1===b.value.length?this.enableButton(!0,"clear"):this.isAccNumber?b.value.length===this.opts.accessNumberDigits&&(this.enableNumberButtons(!1),this.enableButton(!0,"go"),this.enableButton(!0,"clear")):b.value.length===this.cfg.pinSize&&(this.enableNumberButtons(!1),this.enableButton(!0,"go"),this.enableButton(!0,"clear")))):(b.value="",b.placeholder=f.text("pinpad_placeholder_text"),b.type="password",void this.enableNumberButtons(!0))},mpin.prototype.enableButton=function(a,b){var c,d={};d.go={id:"mpinLogin",trueClass:"btn",falseClass:"btn mp_inactive"},d.clear={id:"mpinClear",trueClass:"btn",falseClass:"btn mp_inactive"},d.toggle={id:"mp_toggleButton",trueClass:"mp_DisabledState",falseClass:""},c=document.getElementById(d[b].id),d[b]&&c&&(c.disabled=!a,c.className=d[b][a+"Class"])},mpin.prototype.display=function(a){var c;c=document.getElementById("pinpad-input"),this.isAccNumber&&b(c,"blue-bg"),c.value=a,c.value=""},mpin.prototype.getDisplayName=function(b){b||(b=this.identity);try{return JSON.parse(a(b)).userID}catch(c){return b}},mpin.prototype.toggleButton=function(){var a=this;return document.getElementById("menuBtn")?(console.log("set IDENTITY ;::",typeof this.setIdentity),this.setIdentity(this.identity,!0,function(){a.display(a.cfg.pinpadDefaultMessage)},function(){return!1}),this.renderAccountsPanel(),c("mp_toggleButton","mp_SelectedState"),c("mp_panel","mp_flip")):(document.getElementById("mp_accountID").style.display="none",this.renderAccountsPanel(),b("mp_toggleButton","mp_SelectedState"),b("mp_panel","mp_flip")),!1},mpin.prototype.actionSetupHome=function(){var a=document.getElementById("emailInput").value,b=this;if(0===a.length||!this.opts.emailCheckRegex.test(a))return void document.getElementById("emailInput").focus();console.log("here :::");var c={};c.URL=this.opts.registerURL,c.method="PUT",c.data={userId:a,mobile:0},requestRPS(c,function(a){return console.log("rpsData ::::",a),a.error?void b.error("Activate First"):(b.identity=a.mpinId,b.ds.addIdentity(a.mpinId,""),b.ds.setIdentityData(a.mpinId,{regOTP:a.regOTP}),b.ds.deleteOldIdentity(a.mpinId),void b.renderActivateIdentity())})},mpin.prototype.requestSignature=function(a,b,c){var d=this;console.log("requestSignature :::",arguments),requestClientSecret(d.certivoxClientSecretURL(c),b,function(a){d.enableNumberButtons(!0),d.clientSecret=a,document.getElementById("pinpad-input").value=d.cfg.pinpadDefaultMessage,d.opts.onGetSecret&&d.opts.onGetSecret()},function(a,b){d.error(a,b)})},mpin.prototype.error=function(a){this.opts.onError?this.opts.onError(a):console.error("Error : "+a)},mpin.prototype.actionResend=function(){var a=this;requestRegister(this.opts.registerURL,this.identity,this.opts.authenticateHeaders,this.opts.registerRequestFormatter,function(){a.renderActivateIdentity()},function(b,c){a.error(b,c),a.display(f.text("setupPin_errorSetupPin").mpin_format(c),!0)})},mpin.prototype.actionSetup=function(){var a=this,b=document.getElementById("pinpad-input").value;this.ds.addIdentity(this.identity,""),this.display("Verifying PIN..."),extractPIN(b,this.clientSecret,this.identity,function(b){if(a.ds.setIdentityToken(a.identity,b),a.clientSecret="",a.enableNumberButtons(!1),a.enableButton(!1,"go"),a.ds.setDefaultIdentity(a.identity),a.ds.deleteOldIdentity(a.identity),a.display(f.text("setupPin_pleasewait"),!1),a.opts.setupDoneURL){var c={},d=a.opts.setupDoneURL+"/"+a.identity;c.URL=d,c.method="POST",c.data={},requestRPS(c,function(b){return b.errorStatus?void a.error("ooops"):void a.successSetup()})}else a.successSetup()})},mpin.prototype.actionLogin=function(){var a,b,c,d=this,e=document.getElementById("pinpad-input").value;this.enableNumberButtons(!1),this.enableButton(!1,"go"),this.enableButton(!1,"clear"),this.enableButton(!0,"toggle"),this.display(f.text("authPin_pleasewait")),this.opts.useWebSocket?(b=getAuthToken,a=this.opts.mpinAuthServerURL+"/authenticationToken"):(b=getAuthTokenAjax,a=this.opts.mpinAuthServerURL),c=this.accessNumber,b(a,this.opts.appID,this.identity,this.ds.getIdentityPermit(this.identity),this.ds.getIdentityToken(this.identity),this.opts.requestOTP,"0",this.opts.seedValue,e,this.opts.authenticateURL,this.opts.authenticateRequestFormatter,this.opts.customHeaders,function(a,b,c,e){if(console.log("authenticate arguments :",arguments),a)d.successLogin(e);else if("INVALID"===b)d.display(f.text("authPin_errorInvalidPin"),!1),d.enableNumberButtons(!0),d.enableButton(!1,"go"),d.enableButton(!1,"clear"),d.enableButton(!0,"toggle");else if("MAXATTEMPTS"===b){var g=d.identity;d.deleteIdentity(g),d.opts.onAccountDisabled&&d.opts.onAccountDisabled(g)}},function(){console.log(" Before HandleToken ::::")})},mpin.prototype.setIdentity=function(a,b,c,d){var e,g,h=this;"undefined"!=typeof a&&a?(this.identity=a,e=this.getDisplayName(this.identity)):e="",g=document.getElementById("mpinUser"),g.children[0].innerText=e,g.setAttribute("title",e),b&&(this.addToPin("clear"),this.display(f.text("pinpad_initializing"),!1),this.enableNumberButtons(!1),this.enableButton(!1,"go"),this.enableButton(!1,"clear"),this.enableButton(!0,"toggle"),console.log("before call identity PERMIT :)"),this.requestPermit(a,function(){console.log("call IDENTITY PERMIT :::"),h.enableNumberButtons(!0),c()},function(a,b){404===b?(h.renderIdentityNotActive(e),d()):(h.display(f.text("pinpad_errorTimePermit")+" "+b,!0),h.error("Error getting the time permit.",b),d())}))},mpin.prototype.successSetup=function(a){var b=this;this.opts.successSetupURL?window.location=this.opts.successSetupURL:this.opts.onSuccessSetup?this.opts.onSuccessSetup(a,function(){b.renderSetupDone.call(b)}):this.renderSetupDone()},mpin.prototype.ajax=function(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){4===c.readyState&&200===c.status&&b(JSON.parse(c.responseText))},c.open("GET",a,!0),c.send()},mpin.prototype.ajaxPost=function(a,b,c){var d=new XMLHttpRequest;d.onreadystatechange=function(){4===d.readyState&&200===d.status&&(console.log("POST success ...."),""==d.responseText&&c(!0))},d.open("Post",a,!0),d.send(JSON.stringify(b))},mpin.prototype.setCustomStyle=function(){mpin.custom.frame_background&&document.getElementById("mp_pinpadHolder")&&(document.getElementById("mp_pinpadHolder").style.background=mpin.custom.frame_background)},mpin.prototype.requestPermit=function(a,b,c){var d=this;requestTimePermit(d.certivoxPermitsURL(),d.dtaPermitsURL(),d.opts.authenticateHeaders,function(a){d.ds.setIdentityPermit(d.identity,a),d.ds.save(),d.gotPermit(a),b(a)},function(a,b){c(a,b)})},mpin.prototype.deleteIdentity=function(a){var b="",c=this;this.ds.deleteIdentity(a);for(var d in this.ds.getAccounts()){b=d;break}return b?(this.setIdentity(b,!0,function(){c.display(c.cfg.pinpadDefaultMessage)},function(){return!1}),this.ds.setDefaultIdentity(b),this.renderAccountsPanel()):(this.setIdentity(b,!1),this.ds.setDefaultIdentity(""),this.identity="",this.renderSetupHome()),!1},mpin.prototype.dataSource=function(){var a={},b=this;return this.ds||(this.ds={}),"undefined"==typeof localStorage.mpin&&localStorage.setItem("mpin",JSON.stringify({defaultIdentity:"",version:"0.3",accounts:{}})),a.mpin=JSON.parse(localStorage.getItem("mpin")),a.addIdentity=function(b,c,d){a.mpin.accounts[b]||(a.mpin.accounts[b]={MPinPermit:"",token:""}),a.setIdentityToken(b,c),d&&a.setIdentityPermit(b,d)},a.setIdentityToken=function(b,c){a.mpin.accounts[b].token=c,a.save()},a.setIdentityPermit=function(b,c){a.mpin.accounts[b].MPinPermit=c,a.save()},a.getIdentityPermit=function(b){return b||(b=a.getDefaultIdentity()),a.mpin.accounts[b].MPinPermit},a.getIdentityToken=function(b){return b||(b=a.getDefaultIdentity()),a.mpin.accounts[b].token},a.getDefaultIdentity=function(){return a.mpin.defaultIdentity},a.setDefaultIdentity=function(b){a.mpin.defaultIdentity=b,a.save()},a.deleteOldIdentity=function(c){var d=b.getDisplayName(c);for(var e in this.getAccounts())if(e!==c){var f=b.getDisplayName(e);f===d&&a.deleteIdentity(e)}},a.deleteIdentity=function(b){delete a.mpin.accounts[b],a.save()},a.save=function(){localStorage.setItem("mpin",JSON.stringify(a.mpin))},a.getAccounts=function(){return a.mpin.accounts},a.setIdentityData=function(b,c){for(var d in c)a.mpin.accounts[b][d]=c[d];a.save()},a.getIdentityData=function(b,c){return a.mpin.accounts[b][c]},a},mpin.prototype.successLogin=function(a){this.opts.successLoginURL?window.location=this.opts.successLoginURL:this.opts.onSuccessLogin&&this.opts.onSuccessLogin(a)},mpin.prototype.certivoxClientSecretURL=function(a){return this.opts.certivoxURL+"/clientSecret?"+a},mpin.prototype.dtaClientSecretURL=function(a){return this.opts.mpinDTAServerURL+"clientSecret?"+a},mpin.prototype.certivoxPermitsURL=function(){var a=this.identity;return this.opts.certivoxURL+"/timePermit?app_id="+this.opts.appID+"&mobile=0&mpin_id="+a},mpin.prototype.dtaPermitsURL=function(){var a=this.identity;return this.opts.timePermitsURL+"/"+a},mpin.prototype.gotPermit=function(a){this.opts.onGetPermit&&this.opts.onGetPermit(a)},d=function(a,b){var c=document.createElement("script");c.type="text/javascript",c.src=a,c.readyState?c.onreadystatechange=b:c.onload=b,document.getElementsByTagName("head")[0].appendChild(c)},e.en={},e.en={pinpad_initializing:"Initializing...",pinpad_errorTimePermit:"ERROR GETTING PERMIT:",home_alt_mobileOptions:"Mobile Options",home_button_authenticateMobile:"Authenticate <br/>with your Smartphone",home_button_authenticateMobile_description:"Get your Mobile Access Number to use with your M-Pin Mobile App to securely authenticate yourself to this service.",home_button_getMobile:"Get <br/>M-Pin Mobile App",home_button_getMobile_description:"Install the free M-Pin Mobile App on your Smartphone now!  This will enable you to securely authenticate yourself to this service.",home_button_authenticateBrowser:"Authenticate <br/>with this Browser",home_button_authenticateBrowser_description:"Enter your M-PIN to securely authenticate yourself to this service.",home_button_setupBrowser:"Add an <br/>Identity to this Browser",home_button_setupBrowser_description:"Add your Identity to this web browser to securely authenticate yourself to this service using this machine.",mobileGet_header:"GET M-PIN MOBILE APP",mobileGet_text1:"Scan this QR code",mobileGet_text2:"or open this URL on your mobile:",mobileGet_button_back:"Back",mobileAuth_header:"AUTHENTICATE WITH YOUR M-PIN",mobileAuth_seconds:"seconds",mobileAuth_text1:"Your Access Number is:",mobileAuth_text2:"Note: Use this number in the next",mobileAuth_text3:"with your M-Pin Mobile App.",mobileAuth_text4:"Warning: Navigating away from this page will interrupt the authentication process and you will need to start again to authenticate successfully.",otp_text1:"Your One-Time Password is:",otp_text2:"Note: The password is only valid for<br/>{0} seconds before it expires.",otp_seconds:"Remaining: {0} sec.",otp_expired_header:"Your One-Time Password has expired.",otp_expired_button_home:"Login again to get a new OTP",setup_header:"ADD AN IDENTITY TO THIS BROWSER",setup_text1:"Enter your email address:",setup_text2:"Your email address will be used as your identity when M-Pin authenticates you to this service.",setup_error_unathorized:"{0} has not been registered in the system.",setup_error_server:"Cannot process the request. Please try again later.",setup_error_signupexpired:"Your signup request has been expired. Please try again.",setup_button_setup:"Setup M-Pin&trade;",setupPin_header:"Create your M-Pin with {0} digits",setupPin_initializing:"Initializing...",setupPin_pleasewait:"Please wait...",setupPin_button_clear:"Clear",setupPin_button_done:"Setup Pin",setupPin_errorSetupPin:"ERROR SETTING PIN: {0}",setupDone_header:"Congratulations!",setupDone_text1:"Your M-Pin identity",setupDone_text2:"is setup, now you can login.",setupDone_text3:"",setupDone_button_go:"Login now",setupReady_header:"VERIFY YOUR IDENTITY",setupReady_text1:"Your M-Pin identity",setupReady_text2:"is ready to setup, now you must verify it.",setupReady_text3:"We have just sent you an email, simply click the link to verify your identity.",setupReady_button_go:"Verified your identity? <br/>Setup your M-Pin now",setupReady_button_resend:"Not received the email? <br/>Send it again",setupNotReady_header:"YOU MUST VERIFY <br/>YOUR IDENTITY",setupNotReady_text1:"Your identity",setupNotReady_text2:"has not been verified.",setupNotReady_text3:"You need to click the link in the email we sent you, and then choose <br/> 'Setup M-Pin'.",setupNotReady_check_info1:"Checking",setupNotReady_check_info2:"Identity not verified!",setupNotReady_resend_info1:"Sending email",setupNotReady_resend_info2:"Email sent!",setupNotReady_button_check:"Setup M-Pin",setupNotReady_button_resend:"Send the email again",setupNotReady_button_back:"Go to the identities list",authPin_header:"Enter your M-Pin",authPin_button_clear:"Clear",authPin_button_login:"Login",authPin_pleasewait:"Authenticating...",authPin_success:"Success",authPin_errorInvalidPin:"INCORRECT M-PIN!",authPin_errorNotAuthorized:"You are not authorized!",authPin_errorExpired:"The auth request expired!",authPin_errorServer:"Server error!",deactivated_header:"SECURITY ALERT",deactivated_text1:"has been de-activated and your M-Pin token has been revoked.",deactivated_text2:"To re-activate your identity, click on the blue button below to register again.",deactivated_button_register:"Register again",account_button_addnew:"Add a new identity to this list",account_button_delete:"Remove this M-Pin Identity from this browser",account_button_reactivate:"Forgot my PIN. Send me a new activation email.",account_button_backToList:"Go back to identity list",account_button_cancel:"Cancel and go back",account_delete_question:"Are you sure you wish to remove this M-Pin Identity from this browser?",account_delete_button:"Yes, remove this M-Pin Identity",account_reactivate_question:"Are you sure you wish to reactivate this M-Pin Identity?",account_reactivate_button:"Yes, reactivate this M-Pin Identity",noaccount_header:"No identities have been added to this browser!",noaccount_button_add:"Add a new identity",pinpad_placeholder_text:"Enter your pin",pinpad_placeholder_text2:"Enter your access Number",logout_text1:"YOU ARE NOW LOGGED IN",logout_button:"Logout",home_button_setupMobile:"Add an identity to this browser",mobile_splash_text:"INSTALL THE M-PIN MOBILE APP",mobile_add_home_ios6:"Tap the <img src='/build/out/mobile/resources/templates/grey/img/ios6-share.png'/> icon to 'Add to homescreen'",mobile_add_home_ios7:"Tap the <img src='/build/out/mobile/resources/templates/grey/img/ios7-share.png'/> icon to 'Add to homescreen'"},f.img=function(a){return g+a},f.text=function(a){return e[f.language][a]};var h=function(){String.prototype.mpin_trim="undefined"==typeof String.prototype.trim?function(){return String(this).replace(/^\s+|\s+$/g,"")}:String.prototype.trim,String.prototype.mpin_endsWith=function(a){return this.length>=a.length&&this.substr(this.length-a.length)==a},String.prototype.mpin_format||(String.prototype.mpin_format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})})}}();